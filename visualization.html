<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Airbnb - Calgary 2017 </title>
        <script type="text/javascript" src="d3.v5.min.js"></script>

        <link rel="stylesheet" href="/visualization.css">
    </head>

    <body>
        <div class="page-header gray-background">
            <h1>Airbnb Listings: The City of Calgary</h1>
            <p>Data from July 10th, 2017</p>
        </div>
        <div class="panel">
            <svg>
                <g></g>
            </svg>
        </div>

        <div class="filter-panel panel lighter-gray-background">
            <h2 class="filter-title gray-background">Filters:</h2>
            <!-- Price -->
            <div class="filter-section lighter-gray-background">
                <p>Price</p>
                <div class="input-container">
                    <select class="dropdown inline" id="price-min"></select>
                    <p class="range-text inline">to</p>
                    <select class="dropdown inline" id="price-max"></select>
                </div>
            </div>
            <!-- Rating -->
            <div class="filter-section gray-background">
                <p>Rating</p>
                <div class="input-container">
                    <select class="dropdown" id="rating">
                        <option value="0">All</option>
                        <option value="1">1+</option>
                        <option value="2">2+</option>
                        <option value="3">3+</option>
                        <option value="4">4+</option>
                        <option value="5">5</option>
                    </select>
                </div>
            </div>
            <!-- Number of People -->
            <div class="filter-section lighter-gray-background">
                <p>Number of People</p>
                <div class="input-container">
                    <select class="dropdown" id="people"></select>
                </div>
            </div>
            <!-- Number of Nights -->
            <div class="filter-section gray-background">
                <p> Number of Nights</p>
                <div class="input-container">
                    <select class="dropdown" id="nights"></select>
                </div>
            </div>
            <!-- Room Type -->
            <div class="filter-section lighter-gray-background">
                <p>Room Type</p>
                <div class="input-container">
                    <div class="checkbox-grouping">
                        <input type="checkbox" class="slider" id="private-box"> Private <br>
                    </div>
                    <input type="checkbox" class="slider" id="house-box"> House <br>
                    <input type="checkbox" class="slider" id="shared-box"> Shared
                </div>
            </div>
            <!-- Bedroooms -->
            <div class="filter-section gray-background">
                <p>Bedrooms</p>
                <div class="input-container">
                    <select class="dropdown" id="bedrooms"></select>
                </div>
            </div>
            <!-- Bathrooms -->
            <div class="filter-section lighter-gray-background">
                <p>Bathrooms</p>
                <div class="input-container">
                    <select class="dropdown" id="bathrooms"></select>
                </div>
            </div>
        </div>

        <div id="table-panel" class="panel gray-background">
            <table>
                <tr class="table-headers">
                    <th>Room ID</th>
                    <th>Price (per night)</th>
                    <th>Room Type</th>
                    <th>Rating</th>
                    <th>Accommodates</th>
                    <th>Bed/Bath</th>
                    <th>Neighborhood</th>
                    <th>Min Stay</th>
                </tr>
            </table>
        </div>

        <div class="display-panel panel gray-background"></div>
    </body>

    <script type="text/javascript">
        const WIDTH = 1100;
        const HEIGHT = 500;
        const MIN_RIGHT_PANEL = 230;
        const PRICE_SOFT_CAP = 400;

        var airbnbDict = {}

        // Define map projection
        var projection = d3.geoMercator()
            .center([-114.0708, 51.0486])
            .translate([WIDTH / 2, HEIGHT / 2])
            .scale([40000]);

        // Define path generator
        var path = d3.geoPath()
            .projection(projection);

        var attachZoom = d3.zoom().scaleExtent([1, 15]).on("zoom", function() {
            d3.select("g").attr("transform", d3.event.transform);
        })

        // Modify SVG element
        var svg = d3.select("svg")
            .attr("width", WIDTH)
            .attr("height", HEIGHT)
            .call(attachZoom);

        var innerGraphicContainer = svg.select("g");

        // Define scale quantize to sort price data into colour buckets
        // Colours from: http://colorbrewer2.org/#type=sequential&scheme=Greens&n=5
        var priceColour = d3.scaleQuantize()
            .range(["rgb(186,228,179)", "rgb(116,196,118)", "rgb(49,163,84)", "rgb(0,109,44)"])
            .domain([0, PRICE_SOFT_CAP]);


        // Modify table element
        var table = d3.select("table")
            .attr("width", WIDTH + 2) // accommodate for border on svg
        
        d3.select("#table-panel")
            .style("height", HEIGHT / 2 + "px")

        // TODO: stop header row from scrolling

        // Draws the cartography of Calgary
        function generateMap(json) {
            // Bind data and create one path per GeoJSON feature
            innerGraphicContainer.selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", "steelblue")
                .attr("stroke", "black")
                .append("title")
                .text(function(d) {
                    return d.properties.name;
                });
        }

        // Set the options in the dropdown filters
        function setFilters(accommodates, bedrooms, bathrooms, price, stay) {
            var accommodatesDropdown = d3.select('#people');
            var bedroomsDropdown = d3.select('#bedrooms');
            var bathroomsDropdown = d3.select('#bathrooms');
            var minPriceDropdown = d3.select('#price-min');
            var maxPriceDropdown = d3.select('#price-max');
            var stayDropdown = d3.select('#nights');
            
            // Populate the 'Number of People' dropdown
            for (i = 0; i < accommodates + 1; i++) {
                accommodatesDropdown.append("option")
                    .attr("value", i)
                    .text(i + "+");
            }
            // Populate the 'Bedrooms' dropdown
            for (i = 0; i < bedrooms + 1; i++) {
                bedroomsDropdown.append("option")
                    .attr("value", i)
                    .text(i + "+");
            }
            // Populate the 'Bathrooms' dropdown
            for (i = 0; i < bathrooms + 1; i++) {
                bathroomsDropdown.append("option")
                    .attr("value", i)
                    .text(i + "+");
            }
            // Populate the 'Price' dropdowns in intervals of $50
            for (i = 0; i < price + 1; i+=50) {
                minPriceDropdown.append("option")
                    .attr("value", i)
                    .text("$" + i);
                maxPriceDropdown.append("option")
                    .attr("value", i)
                    .text("$" + i);
            }
            // Populate the 'Number of Nights' dropdown
            for (i = 0; i < stay + 1; i++) {
                stayDropdown.append("option")
                    .attr("value", i)
                    .text(i + "+");
            }
        }

        // Populate the listings dictionary, table, the filter dropdowns, and plot every listing onto the map
        // Note: these could be split up into separate functions but this way it can all be accomplished in one loop.
        // TODO: cleanup large function
        function initalizeListings(data) {
            var listingProjection;
            var maxAccommodates = 0;
            var maxBedrooms = 0;
            var maxBathrooms = 0;
            var maxPrice = 0;
            var maxStay = 0;

            data.forEach(function(d) {
                room_id = d.room_id;
                price = +d.price;
                room_type = d.room_type;
                rating = +d.overall_satisfaction;
                accommodates = +d.accommodates;
                bedrooms = +d.bedrooms;
                bathrooms = +d.bathrooms;
                min_stay = +d.minstay;
                neighborhood = d.neighborhood;

                // Create dictionary entry for listing data
                airbnbDict[room_id] = {
                    'room_type': d.room_type,
                    'borough': d.borough,
                    'neighborhood': neighborhood,
                    'reviews': +d.reviews,
                    'overall_satisfaction': +d.overall_satisfaction,
                    'accommodates': accommodates,
                    'bedrooms': bedrooms,
                    'bathrooms': bathrooms,
                    'price': price,
                    'min_stay': min_stay,
                    'lat': d.latitude,
                    'long': d.longitude
                }

                // Figure out max values for the filter dropdowns
                // Note: this could be hardcoded but I prefer it to be dynamic in case of data changes.
                if (accommodates > maxAccommodates) {
                    maxAccommodates = accommodates;
                }
                if (bedrooms > maxBedrooms) {
                    maxBedrooms = bedrooms;
                }
                if (bathrooms > maxBathrooms) {
                    maxBathrooms = bathrooms;
                }
                if (price > maxPrice) {
                    maxPrice = price;
                }
                if (min_stay > maxStay) {
                    maxStay = min_stay;
                }

                listingProjection = projection([d.longitude, d.latitude])

                // Plot the listing on the map
                innerGraphicContainer
                    .append("circle")
                    .attr("cx", listingProjection[0])
                    .attr("cy", listingProjection[1])
                    .attr("r", 2)
                    .style("fill", price < PRICE_SOFT_CAP ? priceColour(price) : "rgb(0,109,44)");
                
                // Add to the table
                row = table.append("tr")
                row.append("th").text(room_id)
                row.append("th").attr("class", "right-align-text").text("$" + price)
                row.append("th").text(room_type)
                row.append("th").text(rating > 0 ? rating : "/")
                row.append("th").text(accommodates)
                row.append("th").text(bedrooms + "/" + bathrooms)
                row.append("th").text(neighborhood)
                row.append("th").text(min_stay)

            });

            setFilters(maxAccommodates, maxBedrooms, maxBathrooms, maxPrice, maxStay);
        }

        // Load in GeoJSON data
        d3.json("data/calgary.geojson").then(function(json) {
            generateMap(json);

            //Load in cities data
            d3.csv("data/tomslee_airbnb_calgary_1443_2017-07-10.csv").then(function(data) {
                initalizeListings(data);
            });
        });

        // *** FILTER PANEL ***

        var bodyWidth = +d3.select("body").node().getBoundingClientRect().width;
        // Total width - svg width - (borders + padding)
        var rightPanelWidth = bodyWidth - (WIDTH) - 14;

        var filterPanel = d3.select('.filter-panel')
            .style("width", Math.max(rightPanelWidth, MIN_RIGHT_PANEL) + "px")
            .style("height", HEIGHT + "px");

        // TODO: append options to dropdowns based on min/max values

        // *** DISPLAY PANEL ***

        var displayPanel = d3.select('.display-panel')
            .style("width", Math.max(rightPanelWidth, MIN_RIGHT_PANEL) + "px")
            .style("height", HEIGHT / 2 + "px");

        // *** LEGEND ***

        var legend = svg.append("rect")
            .attr("fill", "rgb(56, 56, 56)")
            .attr("x", "12px")
            .attr("y", "420px")
            .attr("width", "200px")
            .attr("height", "68px")
            .attr("stroke", "black")
            .attr("stroke-width", "1px");

    </script>
</html>