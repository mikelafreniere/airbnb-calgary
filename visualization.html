<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Airbnb - Calgary 2017 </title>
        <script type="text/javascript" src="d3.v5.min.js"></script>

        <link rel="stylesheet" href="/visualization.css">
    </head>

    <body>
        <div class="page-header gray-background">
            <h1>Airbnb Listings: The City of Calgary</h1>
            <p>Data from July 10th, 2017</p>
        </div>
        <div class="panel">
            <svg>
                <g></g>
            </svg>
        </div>

        <div class="filter-panel panel lighter-gray-background">
            <h2 class="filter-title gray-background">Filters:</h2>
            <!-- Price -->
            <div class="filter-section lighter-gray-background">
                <p>Price</p>
                <div class="input-container">
                    <select class="dropdown inline" name="price-min"></select>
                    <p class="range-text inline">to</p>
                    <select class="dropdown inline" name="price-max"></select>
                </div>
            </div>
            <!-- Rating -->
            <div class="filter-section gray-background">
                <p>Rating</p>
                <div class="input-container">
                    <select class="dropdown" name="rating"></select>
                </div>
            </div>
            <!-- Number of People -->
            <div class="filter-section lighter-gray-background">
                <p>Number of People</p>
                <div class="input-container">
                    <select class="dropdown" name="people"></select>
                </div>
            </div>
            <!-- Number of Nights -->
            <div class="filter-section gray-background">
                <p> Number of Nights</p>
                <div class="input-container">
                    <select class="dropdown" name="nights"></select>
                </div>
            </div>
            <!-- Room Type -->
            <div class="filter-section lighter-gray-background">
                <p>Room Type</p>
                <div class="input-container">
                    <div class="checkbox-grouping">
                        <input type="checkbox" class="slider" name="house-box"> House <br>
                        <input type="checkbox" class="slider" name="apartment-box"> Apartment
                    </div>
                    <input type="checkbox" class="slider" name="private-box"> Private <br>
                    <input type="checkbox" class="slider" name="shared-box"> Shared
                </div>
            </div>
            <!-- Bedroooms -->
            <div class="filter-section gray-background">
                <p>Bedrooms</p>
                <div class="input-container">
                    <select class="dropdown" name="bedrooms"></select>
                </div>
            </div>
            <!-- Bathrooms -->
            <div class="filter-section lighter-gray-background">
                <p>Bathrooms</p>
                <div class="input-container">
                    <select class="dropdown" name="bathrooms"></select>
                </div>
            </div>
        </div>

        <table class="listings-table panel gray-background">
            <tr class="table-headers">
                <th>Room ID</th>
                <th>Price (per night)</th>
                <th>Room Type</th>
                <th>Rating</th>
                <th>Accomodates</th>
                <th>Bed/Bath</th>
                <th>Neighborhood</th>
                <th>Min Stay</th>
            </tr>
        </table>

        <div class="display-panel panel gray-background"></div>
    </body>

    <script type="text/javascript">
        const WIDTH = 1100;
        const HEIGHT = 500;
        const MIN_RIGHT_PANEL = 230;

        var airbnbDict = {}

        // Define map projection
        var projection = d3.geoMercator()
            .center([-114.0708, 51.0486])
            .translate([WIDTH / 2, HEIGHT / 2])
            .scale([40000]);

        // Define path generator
        var path = d3.geoPath()
            .projection(projection);

        var attachZoom = d3.zoom().scaleExtent([1, 15]).on("zoom", function() {
            d3.select("g").attr("transform", d3.event.transform);
        })

        // Modify SVG element
        var svg = d3.select("svg")
            .attr("width", WIDTH)
            .attr("height", HEIGHT)
            .call(attachZoom);

        var innerGraphicContainer = svg.select("g");

        // Modify table element
        var table = d3.select("table")
            .attr("width", WIDTH + 2) // accomodate for border on svg
            .attr("max-height", HEIGHT / 2);

        // Draws the cartography of Calgary
        function generateMap(json) {
            // Bind data and create one path per GeoJSON feature
            innerGraphicContainer.selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", "steelblue")
                .attr("stroke", "black")
                .append("title")
                .text(function(d) {
                    return d.properties.name;
                });
        }

        // Populate the listings dictionary and plot every listing on the map
        function initalizeListings(data) {
            var listingProjection

            data.forEach(function(d) {
                // Create dictionary entry for listing data
                airbnbDict[d.room_id] = {
                    'room_type': d.room_type,
                    'borough': d.borough,
                    'neighborhood': d.neighborhood,
                    'reviews': d.reviews,
                    'overall_satisfaction': d.overall_satisfaction,
                    'accomodates': d.accomodates,
                    'bedrooms': d.bedrooms,
                    'bathrooms': d.bathrooms,
                    'price': d.price,
                    'min_stay': d.minstay,
                    'lat': d.latitude,
                    'long': d.longitude
                }

                listingProjection = projection([d.longitude, d.latitude])

                // Plot the listing on the map
                innerGraphicContainer
                    .append("circle")
                    .attr("cx", listingProjection[0])
                    .attr("cy", listingProjection[1])
                    .attr("r", 1)
                    .style("fill", "yellow");
            });
        }

        // Load in GeoJSON data
        d3.json("data/calgary.geojson").then(function(json) {
            generateMap(json);

            //Load in cities data
            d3.csv("data/tomslee_airbnb_calgary_1443_2017-07-10.csv").then(function(data) {
                initalizeListings(data);
            });
        });

        // *** FILTER PANEL ***

        var bodyWidth = +d3.select("body").node().getBoundingClientRect().width;
        // Total width - svg width - (borders + padding)
        var rightPanelWidth = bodyWidth - (WIDTH) - 14;

        var filterPanel = d3.select('.filter-panel')
            .style("width", Math.max(rightPanelWidth, MIN_RIGHT_PANEL) + "px")
            .style("height", HEIGHT + "px");

        // TODO: append options to dropdowns based on min/max values

        // *** DISPLAY PANEL ***

        var displayPanel = d3.select('.display-panel')
            .style("width", Math.max(rightPanelWidth, MIN_RIGHT_PANEL) + "px")
            .style("height", HEIGHT / 2 + "px");

        // *** LEGEND ***

        var legend = svg.append("rect")
            .attr("fill", "rgb(56, 56, 56)")
            .attr("x", "12px")
            .attr("y", "420px")
            .attr("width", "200px")
            .attr("height", "68px")
            .attr("stroke", "black")
            .attr("stroke-width", "1px");

    </script>
</html>